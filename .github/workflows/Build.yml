name: Build and release static export

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:  # 添加手动触发
    inputs:
      environment:
        description: '选择部署环境'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: '跳过测试'
        required: false
        type: boolean
        default: false
      release_notes:
        description: '发布说明'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "latest"

      - name: Install dependencies
        run: bun install

      # 可选：添加条件测试步骤
      - name: Run tests
        if: ${{ !github.event.inputs.skip_tests }}
        run: bun test

      - name: Build static export
        run: |
          bun run build

      - name: Compress dist folder
        run: zip -r dist.zip dist

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist.zip
          tag_name: ${{ github.event.inputs.environment == 'production' && github.ref_name || format('{0}-{1}', github.event.inputs.environment, github.sha) }}
          body: ${{ github.event.inputs.release_notes }}

      - name: Changelog
        if: ${{ github.event_name == 'push' }}  # 只在标签推送时生成 changelog
        run: bun x changelogithub
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      # 添加手动触发的确认步骤
      - name: Manual trigger info
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "手动触发信息:"
          echo "环境: ${{ github.event.inputs.environment }}"
          echo "跳过测试: ${{ github.event.inputs.skip_tests }}"
          echo "发布说明: ${{ github.event.inputs.release_notes || '无' }}"
